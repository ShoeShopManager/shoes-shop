<div class="container">
    <div class="md:flex min-h-[300px]">
        <div class="w-full">
            <div class="breadcrumbs text-sm">
                <ul>
                    <li><a href="/">Trang chủ</a></li>
                    <li>Giỏ hàng của bạn</li>
                </ul>
            </div>
            <div class="md:grid md:grid-cols-3 gap-10">
                <!-- Cart -->
                <div class="col-span-2">
                    <div>
                        <% if (cart && cart.danhSachSanPham) { %>
                            <% cart.danhSachSanPham.forEach(item => { %>
                                <div  
                                    data-productId="<%= item.maSanPham.maSanPham %>" 
                                    data-productStockQuantity="<%= item.soLuongTon %>"
                                    data-productPrice="<%= item.giaSanPham %>"
                                    class="flex justify-between items-center mt-6 pt-6">
                                    <div class="flex items-center">
                                        <input
                                            type="checkbox"
                                            id=""
                                            name="item[]"
                                            class="checkbox checkbox-sm [--chkbg:#0578f8]"
                                        />
                                        <img
                                            src="<%= item.maSanPham.hinhAnhDaiDien || "/images/no-result.png" %>"
                                            width="60"
                                            class="rounded-xl ms-2"
                                        />
        
                                        <div class="flex flex-col ml-3">
                                            <span class="md:text-md font-medium">
                                                <%= item.maSanPham.tenSanPham %>
                                            </span>
                                            <span class="text-sm font-light text-gray-500">
                                                Kích cỡ: <%= item.maKichCoSanPham.tenKichCo %>
                                                - Giá: <%= formatVNCurrency(item.giaSanPham) %>
                                            </span>
                                        </div>
                                    </div>
        
                                    <div class="flex justify-center items-center">
                                        <div class="pr-8">
                                            <span class="total-price">
                                                <%= formatVNCurrency(item.giaSanPham * item.soLuongSanPham) %>
                                            </span>
                                        </div>
        
                                        <div class="pr-8 flex items-center text-lg">
                                            <button class="decrease-btn font-semibold p-2 cursor-pointer">
                                                <i class="bx bx-minus"></i>
                                            </button>
                                            <div
                                                class="quantity-select-value flex justify-center items-center text-base focus:outline-none bg-gray-100 border px-3 rounded"
                                            >
                                                <%= item.soLuongSanPham %>
                                            </div>
                                            <button class="increase-btn font-semibold p-2 cursor-pointer">
                                                <i class="bx bx-plus"></i>
                                            </button>
                                        </div>
        
                                        <button class="delete-cart-item-btn text-red-500 text-lg">
                                            <i class="bx bx-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p>Không có sản phẩm nào trong giỏ hàng.</p>
                        <% } %>

                        
                    </div>

                    <div class="flex justify-between items-center mt-6 pt-6 border-t">
                        <div class="flex items-center">
                            <i class="fa fa-arrow-left text-sm pr-2"></i>
                            <a href="/product" class="text-md font-medium text-blue-500">Tiếp tục mua sắm</a>
                        </div>
                    </div>
                </div>

                <!-- SUMMARY -->
                <div class="p-5 bg-gray-100 rounded-2xl overflow-visible">
                    <span class="text-xl font-medium block mb-3">Tóm tắt</span>

                    <p class="flex items-center justify-between py-2 border-b">
                        <span class="text-neutral-600">Số sản phẩm đã chọn</span>
                        <span class="block text">1</span>
                    </p>

                    <p class="flex items-center justify-between py-2">
                        <span class="text-neutral-600">Tạm tính</span>
                        <span class="block text">$10.50</span>
                    </p>

                    <button class="mt-3 h-12 w-full bg-primary rounded-full focus:outline-none text-white">
                        Thanh toán
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const deleteCartItemBtns = document.querySelectorAll(".delete-cart-item-btn");

    const increaseBtn = document.querySelectorAll('.increase-btn')
    const decreaseBtn = document.querySelectorAll('.decrease-btn')

    let updateCartTimeout;

    const formatVNCurrency = (value) => {
        return value.toLocaleString("vi-VN", {
            style: "currency",
            currency: "VND",
        });
    };

    // Delete cart item
    deleteCartItemBtns.forEach(btn => {
        btn.onclick = async function() {
            const cartItem = this.closest("[data-productId]")
            const productId = cartItem.getAttribute("data-productId");
            
            if (!productId) return;

            // Call API to delete item from cart
            const res = await fetch("/cart/api/delete/" + productId, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            })

            if (res.ok) {
                // Remove item from DOM
                cartItem.remove();
            }
        }
    })

    increaseBtn.forEach(btn => {
        btn.onclick = function () {
            const selectedValue = this.parentElement.querySelector('.quantity-select-value');
            const stockQuantity = this.closest("[data-productStockQuantity]").getAttribute("data-productStockQuantity");
            const productId = this.closest("[data-productId]").getAttribute("data-productId");

            const productPrice = this.closest("[data-productPrice]").getAttribute("data-productPrice");

            // Find class total-price
            const totalPrice = this.closest("[data-productPrice]").querySelector(".total-price");
            
            if (Number(selectedValue.innerText) >= Number(stockQuantity)) {
                return
            }
            
            // Increase the value
            selectedValue.innerText = Number(selectedValue.innerText) + 1;

            // Render total price

            totalPrice.innerText = formatVNCurrency(Number(productPrice) * Number(selectedValue.innerText));
            

            debounceUpdateCart(productId, Number(selectedValue.innerText));
        }
    })

    decreaseBtn.forEach(btn => {
        btn.onclick = function () {
            const selectedValue = this.parentElement.querySelector('.quantity-select-value');
            const productId = this.closest("[data-productId]").getAttribute("data-productId");

            const productPrice = this.closest("[data-productPrice]").getAttribute("data-productPrice");

            // Find class total-price
            const totalPrice = this.closest("[data-productPrice]").querySelector(".total-price");

            // Decrease the value
            if (Number(selectedValue.innerText) > 1) {
                selectedValue.innerText = Number(selectedValue.innerText) - 1;

                // Render total price
                totalPrice.innerText = formatVNCurrency(Number(productPrice) * Number(selectedValue.innerText));

                debounceUpdateCart(productId, Number(selectedValue.innerText));
            }

        }
    })


    const updateCartQuantityRequest = async (productId, newQuantity) => {
        try {
            const res = await fetch("/cart/api/update-quantity", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: newQuantity
                })
            })
        } catch (error) {
            console.log("error: ", error);
        }
    }

    const debounceUpdateCart = (productId, newQuantity) => {
        if (updateCartTimeout) {
            clearTimeout(updateCartTimeout);
        }
        updateCartTimeout = setTimeout(() => {
            updateCartQuantityRequest(productId, newQuantity);
        }, 700); // Delay 0.7s before sending the request
    };
    
</script>